
# mbed-config-gen

## Overview

The new Mbed CLI 2 (for Mbed OS 6.5 and newer) does not generate a C/C++ header
file (`mbed_config.h`) containing project configurations like the previous
version (Mbed CLI 1) did. This causes some inconvenience when working with Mbed
projects from external IDEs, i.e., Visual Studio Code, as Intellisense cannot
find preprocessor definitions for Mbed projects and doesn't work properly.
This pip package provides a command-line tool to generate a C/C++ header file,
or to update Visual Studio Code C/C++ properties
(`.vscode/c_cpp_properties.json`) for Mbed projects.

## Installation

To install `mbed-config-gen` package, clone this GitHub repository first:
```
$ git clone https://github.com/sterngerlach/mbed-config-gen.git
$ cd mbed-config-gen
```
Then run the following command:
```
$ pip3 install .
```
Or the following command:
```
$ python3 setup.py install
```

`mbed-config-gen` requires `mbed-tools` package (newer than 7.44.0),
which will be automatically installed by `pip`.
For more details, please refer to the
[mbed-tools GitHub repository](https://github.com/ARMmbed/mbed-tools).

To uninstall, run the following command:
```
$ pip3 uninstall mbed-config-gen
```

`mbed-config-gen` package is tested in the following environment:
- Ubuntu 20.04.3 LTS (64-bit)
- Python 3.9.7
- mbed-tools 7.44.0 and 7.50.0
- Mbed OS 6.15

## Usage

Use `-h` or `--help` option to print usage:
```
mbed-config-gen [-h] -t {ARM,GCC_ARM} -m MBED_TARGET -p PROGRAM_PATH
                [-b PROFILE]
                [--mbed-os-path MBED_OS_PATH]
                [--custom-targets-json CUSTOM_TARGETS_JSON]
                [--cmake-build-dir CMAKE_BUILD_DIR]
                [--app-config APP_CONFIG] --output {Header,VSCode}
                [--additional-macros-path ADDITIONAL_MACROS_PATH]
                [--vscode-config-path VSCODE_CONFIG_PATH]
                [--vscode-config-name VSCODE_CONFIG_NAME]
                [--header-path HEADER_PATH]
```

### `-t` or `--toolchain` option (required)
- Toolchain to build the Mbed application.
- Should be either `ARM` or `GCC_ARM` (same as the `mbed-tools`).

### `-m` or `--mbed-target` option (required)
- Build target for an Mbed-enabled device (e.g., `DISCO_L072CZ_LRWAN1`).

### `-p` or `--program-path` option (optional)
- Path to the Mbed program.
- By default, it is set to `.` (i.e., the current working directory).

### `-b` or `--profile` option (optional)
- Build type (e.g., `release`, `develop`, or `debug`).
- By default, it is set to `develop`.
- Used to search for the CMake build output directory, i.e.,
`<Project Root>/cmake_build/<Target>/<Profile>/<Toolchain>`.
  - `<Project Root>` is the path to the Mbed program (`-p` option).
  - `<Target>` is the build target device (`-m` option) in uppercase.
  - `<Profile>` is the build type (`-b` option) in lowercase.
  - `<Toolchain>` is the toolchain (`-t` option) in uppercase.
- The above directory is then used to search for the `compile_time_defs.txt`
generated by the Mbed CMake toolchain.

### `--mbed-os-path` option (optional)
- Path to the Mbed OS.
- By default, it is set to `<Project Root>/mbed-os`.
  - `<Project Root>` is the path to the Mbed program (`-p` option).

### `--custom-targets-json` option (optional)
- Path to the `custom_targets.json`.
- Refer to the `mbed-tools` for more details.

### `--cmake-build-dir` option (optional)
- Path to the CMake build output directory.
- If not specified, it is set to
`<Project Root>/cmake_build/<Target>/<Profile>/<Toolchain>`.
This directory is then used to search for the `compile_time_defs.txt`
generated by the Mbed CMake toolchain.

### `--app-config` option (optional)
- Path to the Mbed project configuration file.
- By default, it is set to `<Project Root>/mbed_app.json`.
  - `<Project Root>` is the path to the Mbed program (`-p` option).

### `--output` option (required)
- Output type.
- Should be either `Header` or `VSCode`.
- If set to `Header`, a C/C++ header file containing Mbed project
configurations is generated. Use `--header-path` option to specify the path
to the header file.
- If set to `VSCode`, VSCode C/C++ properties are updated.
**`--vscode-config-name` option is required** to specify the entry in the
properties file. `--vscode-config-path` option can also be used to specify
the path to the properties file.

### `--additional-macros-path` option (optional)
- Path to the file containing additional macros (and their values).
- Macros and values in this file are inserted to the output C/C++ headers
or `defines` property in the VSCode C/C++ properties as described later.
- The file should look like the following. It contains a list of macros,
separated by a newline character. You can also specify the corresponding
value after `=` (equal).
  ```
  $ cat macros.txt
  A="hoge"
  B
  C="fuga"
  D=123
  E="hehe"
  ```

### `--vscode-config-path` option (optional)
- Path to the VSCode C/C++ properties file.
- If not specified, it is set to `<Project Root>/.vscode/c_cpp_properties.json`.

### `--vscode-config-name` option (required)
- Name of the updated entry (configuration) in the VSCode C/C++ properties file.
- Suppose you are using the following VSCode C/C++ properties file containing
two configurations (`Mbed` and `Linux`). If you want to append Mbed project
configurations to the `Mbed` entry, set `--vscode-config-name` option to `Mbed`.
  ```json
  {
    "configurations": [
      {
        "name": "Mbed",
        "includePath": [
          "${workspaceFolder}/**"
        ],
        "compilerPath": "/usr/bin/arm-none-eabi-gcc",
        "cStandard": "c17",
        "cppStandard": "c++17",
        "intelliSenseMode": "gcc-arm"
      },
      {
        "name": "Linux",
        "includePath": [
          "${workspaceFolder}/**"
        ],
        "compilerPath": "/usr/bin/gcc",
        "cStandard": "gnu17",
        "cppStandard": "gnu++14",
        "intelliSenseMode": "linux-gcc-x64"
      }
    ],
    "version": 4
  }
  ```
  The updated C/C++ properties file should look like this (`defines` property
  is newly created if it does not exist and Mbed project configurations are
  inserted). VSCode C/C++ Intellisense is now able to find Mbed project
  configurations and starts to work correctly.
  ```json
  {
    "configurations": [
      {
        "name": "Mbed",
        "includePath": [
          "${workspaceFolder}/**"
        ],
        "compilerPath": "/usr/bin/arm-none-eabi-gcc",
        "cStandard": "c17",
        "cppStandard": "c++17",
        "intelliSenseMode": "gcc-arm",
        "defines": [
          "ARM_MATH_CM0PLUS",
          "CLOCK_SOURCE=USE_PLL_HSI",
          "COMPONENT_SX1276=1",
          "DEVICE_ANALOGIN=1",
          "DEVICE_ANALOGOUT=1",
          ...
          "USE_HAL_DRIVER",
          "_RTE_",
          "__CMSIS_RTOS",
          "__CORTEX_M0PLUS",
          "__MBED__=1"
        ]
      },
      {
        "name": "Other",
        "includePath": [
          "${workspaceFolder}/**"
        ],
        "compilerPath": "/usr/bin/gcc",
        "cStandard": "gnu17",
        "cppStandard": "gnu++14",
        "intelliSenseMode": "linux-gcc-x64"
      }
    ],
    "version": 4
  }
  ```

### `--header-path` option (optional)
- Path to the generated C/C++ header file.
- If not specified, it is set to `<Project Root>/mbed_config.h`.
- If the file already exists, **it is overwritten**.
- The generated header looks like this:
  ```c
  // mbed_config.h
  
  // Automatically generated configuration file.
  // Do not edit. Content may be overwritten.
  
  #ifndef MBED_CONFIG_H
  #define MBED_CONFIG_H
  
  #define ARM_MATH_CM0PLUS
  #define CLOCK_SOURCE USE_PLL_HSI
  #define COMPONENT_SX1276 1
  #define DEVICE_ANALOGIN 1
  #define DEVICE_ANALOGOUT 1
  ...
  #define USE_HAL_DRIVER
  #define _RTE_
  #define __CMSIS_RTOS
  #define __CORTEX_M0PLUS
  #define __MBED__ 1

  #endif MBED_CONFIG_H
  ```
- Include the generated header from your C/C++ sources.

### Cautions
- Before using `mbed-config-gen`, run `mbed-tools configure`.
Check that `compile_time_defs.txt` is present in the directory
`<Project Root>/cmake_build/<Target>/<Profile>/<Toolchain>/mbed-os`, since
`mbed-config-gen` uses this file to retrieve Mbed project configurations.
If `compile_time_defs.txt` is old, VSCode C/C++ properties or generated C/C++
headers will also contain old configurations, which are inconsistent to the
current ones.

- `compile_time_defs.txt` is not used if it doesn't exist. `mbed-config-gen`
uses `mbed-tools` package and also the file specified by
`--additional-macros-path` option to collect Mbed project configurations,
though some configurations may be missing (e.g., `MBED_CONF_*_PRESENT`).

- `mbed-config-gen` considers the configurations in the following priority:
  1. Configurations in the file specified by `--additional-macros-path` option
  2. Configurations collected by `mbed-tools` package
  3. Configurations in `compile_time_defs.txt`

- This means that if the file specified by `--additional-macros-path` option
contains the same configurations as `compile_time_defs.txt` or the ones
collected by `mbed-tools` package, configurations in the file specified by
`--additional-macros-path` are used.

### Examples

Assume that `~mbed-projects/test` is a root of the Mbed project.
Run the following command to generate a C/C++ header
(`~/mbed-projects/test/mbed_config.h`):
```
$ cd ~mbed-projects/test
$ mbed-config-gen -t GCC_ARM -m DISCO_L072CZ_LRWAN1 --output Header
Compile-time definitions /home/lab/mbed-projects/test/cmake_build/DISCO_L072CZ_LRWAN1/develop/GCC_ARM/mbed-os/compile_time_defs.txt generated by Mbed CMake toolchain is being used. Make sure that `mbed-tools configure` is run before using this tool.
/home/lab/mbed-projects/test/mbed_config.h has been successfully created.

$ cat mbed_config.h

// mbed_config.h

// Automatically generated configuration file.
// Do not edit. Content may be overwritten.

#ifndef MBED_CONFIG_H
#define MBED_CONFIG_H

#define ARM_MATH_CM0PLUS
#define CLOCK_SOURCE USE_PLL_HSI
#define COMPONENT_SX1276 1
#define DEVICE_ANALOGIN 1
#define DEVICE_ANALOGOUT 1
...
#define USE_HAL_DRIVER
#define _RTE_
#define __CMSIS_RTOS
#define __CORTEX_M0PLUS
#define __MBED__ 1

#endif MBED_CONFIG_H
```
Or, run the following command to update VSCode C/C++ properties
(`~/mbed-projects/test/.vscode/c_cpp_properties.json`).
Note that `c_cpp_properties.json` contains `Linux` entry.
```
$ cat .vscode/c_cpp_properties.json
{
  "configurations": [
    {
      "name": "Linux",
      "includePath": [
        "${workspaceFolder}/**",
        "${workspaceFolder}/mbed-os"
      ],
      "compilerPath": "/usr/bin/gcc",
      "cStandard": "gnu17",
      "cppStandard": "gnu++14",
      "intelliSenseMode": "linux-gcc-x64"
    }
  ],
  "version": 4
}

$ mbed-config-gen -t GCC_ARM -m DISCO_L072CZ_LRWAN1 --output VSCode --vscode-config-name Linux
Compile-time definitions /home/lab/mbed-projects/test/cmake_build/DISCO_L072CZ_LRWAN1/develop/GCC_ARM/mbed-os/compile_time_defs.txt generated by Mbed CMake toolchain is being used. Make sure that `mbed-tools configure` is run before using this tool.
/home/lab/mbed-projects/test/.vscode/c_cpp_properties.json has been successfully updated.

$ cat .vscode/c_cpp_properties.json
{
  "configurations": [
    {
      "name": "Linux",
      "includePath": [
        "${workspaceFolder}/**",
        "${workspaceFolder}/mbed-os"
      ],
      "compilerPath": "/usr/bin/gcc",
      "cStandard": "gnu17",
      "cppStandard": "gnu++14",
      "intelliSenseMode": "linux-gcc-x64",
      "defines": [
        "ARM_MATH_CM0PLUS",
        "CLOCK_SOURCE=USE_PLL_HSI",
        "COMPONENT_SX1276=1",
        "DEVICE_ANALOGIN=1",
        "DEVICE_ANALOGOUT=1",
        "DEVICE_CRC=1",
        ...
        "USE_HAL_DRIVER",
        "_RTE_",
        "__CMSIS_RTOS",
        "__CORTEX_M0PLUS",
        "__MBED__=1"
      ]
    }
  ],
  "version": 4
}
```
If you want to append additional configurations
(`~/mbed-projects/test/macros.txt`), run the following command:
```
$ cat macros.txt 
A="hoge"
B
C="fuga"
D=123
E="hehe"

$ mbed-config-gen -t GCC_ARM -m DISCO_L072CZ_LRWAN1 --output Header --additional-macros-path macros.txt
Compile-time definitions /home/lab/mbed-projects/test/cmake_build/DISCO_L072CZ_LRWAN1/develop/GCC_ARM/mbed-os/compile_time_defs.txt generated by Mbed CMake toolchain is being used. Make sure that `mbed-tools configure` is run before using this tool.
/home/lab/mbed-projects/test/mbed_config.h has been successfully created.

$ cat mbed_config.h

// mbed_config.h

// Automatically generated configuration file.
// Do not edit. Content may be overwritten.

#ifndef MBED_CONFIG_H
#define MBED_CONFIG_H

#define A "hoge"
#define ARM_MATH_CM0PLUS
#define B
#define C "fuga"
#define CLOCK_SOURCE USE_PLL_HSI
#define COMPONENT_SX1276 1
#define D 123
#define DEVICE_ANALOGIN 1
#define DEVICE_ANALOGOUT 1
#define DEVICE_CRC 1
#define DEVICE_FLASH 1
#define DEVICE_I2C 1
...
#define DEVICE_SPI_ASYNCH 1
#define DEVICE_STDIO_MESSAGES 1
#define DEVICE_TRNG 1
#define DEVICE_USTICKER 1
#define DEVICE_WATCHDOG 1
#define E "hehe"
#define EXTRA_IDLE_STACK_REQUIRED
#define LPTICKER_DELAY_TICKS 0
...
```
